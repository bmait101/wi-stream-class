---
title: "WI Stream Classes - Exploratory Analyses"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
ragg_png = function(..., res = 150) {
  ragg::agg_png(..., res = res, units = "in")
}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      dev = "ragg_png", res = 500, retina = 1)
```


```{r prep, warning=FALSE, message=FALSE}
# packages
library(tidyverse)  # data manipulation
library(cluster)    # clustering algorithms
library(factoextra) # clustering algorithms & visualization
library(patchwork)  # panel plots
library(vegan)      # community analsyses
library(pdftools)   # covert pdfs to pngs
```

## Data

```{r data}
# read in
df_fish_pa <- readRDS(here::here("data", "df_fish_pa.rds"))
df_fish_pa_sport <- readRDS(here::here("data", "df_fish_pa_sport.rds"))
df_attrbs <- readRDS(here::here("data", "df_attrbs.rds"))

# make rownames
df <- df_fish_pa %>% column_to_rownames("reach_id")
dfs <- df_fish_pa_sport %>% column_to_rownames("reach_id")

```

## k-mean cluster analysis

### All species P/A

Do the clustering:

```{r}
k2 <- kmeans(df, centers = 2, nstart = 25)
k3 <- kmeans(df, centers = 3, nstart = 25)
k4 <- kmeans(df, centers = 4, nstart = 25)
k5 <- kmeans(df, centers = 5, nstart = 25)

```

Plots to compare clusters:

```{r plot-k-means-all-fish, fig.align='center', fig.width=12, fig.height=8}
p1 <- fviz_cluster(k2, geom = "point", data = df) + ggtitle("k = 2")
p2 <- fviz_cluster(k3, geom = "point",  data = df) + ggtitle("k = 3")
p3 <- fviz_cluster(k4, geom = "point",  data = df) + ggtitle("k = 4")
p4 <- fviz_cluster(k5, geom = "point",  data = df) + ggtitle("k = 5")

(p.all.spp <- (p1 + p2) / (p3 + p4) )

ggsave(here::here("plots", "explore", "kmeans_fish.pdf"), 
       width = 12, height = 8, device = cairo_pdf)
```


### Only sportfish P/A

Do the clustering:

```{r}
k2s <- kmeans(dfs, centers = 2, nstart = 25)
k3s <- kmeans(dfs, centers = 3, nstart = 25)
k4s <- kmeans(dfs, centers = 4, nstart = 25)
k5s <- kmeans(dfs, centers = 5, nstart = 25)

```


Plots to compare clusters:

```{r plot-k-means-sportfish, fig.align='center', fig.width=12, fig.height=8}
p1s <- fviz_cluster(k2s, geom = "point", data = dfs) + ggtitle("k = 2")
p2s <- fviz_cluster(k3s, geom = "point",  data = dfs) + ggtitle("k = 3")
p3s <- fviz_cluster(k4s, geom = "point",  data = dfs) + ggtitle("k = 4")
p4s <- fviz_cluster(k5s, geom = "point",  data = dfs) + ggtitle("k = 5")

(p.sportfish <- (p1s + p2s) / (p3s + p4s) )

ggsave(here::here("plots", "explore", "kmeans_sportfish.pdf"), 
       width = 12, height = 8, device = cairo_pdf)
```

### Environmental variables

Do the clustering:

```{r}
# filter out reaches with fish data
dfe <- df_attrbs %>% 
  filter(reach_id %in% df_fish_pa$reach_id) %>% 
  select(!ends_with("dist")) %>%   # to many NAs
  column_to_rownames("reach_id") %>% 
  na.omit()
```

```{r}
k2e <- kmeans(dfe, centers = 2, nstart = 25)
k3e <- kmeans(dfe, centers = 3, nstart = 25)
k4e <- kmeans(dfe, centers = 4, nstart = 25)
k5e <- kmeans(dfe, centers = 5, nstart = 25)

```

Plots to compare clusters:

```{r plot-k-means-env, fig.align='center', fig.width=12, fig.height=8}
p1 <- fviz_cluster(k2e, geom = "point", data = dfe) + ggtitle("k = 2")
p2 <- fviz_cluster(k3e, geom = "point",  data = dfe) + ggtitle("k = 3")
p3 <- fviz_cluster(k4e, geom = "point",  data = dfe) + ggtitle("k = 4")
p4 <- fviz_cluster(k5e, geom = "point",  data = dfe) + ggtitle("k = 5")

(p.all.spp <- (p1 + p2) / (p3 + p4) )

ggsave(here::here("plots", "explore", "kmeans_enviro.pdf"), 
       width = 12, height = 8, device = cairo_pdf)
```

### Slected Environmental variables

Do the clustering:

```{r}
# filter out reaches with fish data
dfe <- df_attrbs %>% 
  filter(reach_id %in% df_fish_pa$reach_id) %>% 
  select(reach_id,
    trw_area, gradient, sinuosity, 
    w_prcp_ann, trw_prcp_ann, 
    temp_max_cl_cc, temp_july_cl_cc, temp_summer_cl_cc, 
    apr_e10_c, aug_e50_c, wy_e50_c, wy_e90_c | contains("temp")
    ) %>% 
  column_to_rownames("reach_id") %>% 
  na.omit()
```

```{r}
k2e <- kmeans(dfe, centers = 2, nstart = 25)
k3e <- kmeans(dfe, centers = 3, nstart = 25)
k4e <- kmeans(dfe, centers = 4, nstart = 25)
k5e <- kmeans(dfe, centers = 5, nstart = 25)
k7e <- kmeans(dfe, centers = 7, nstart = 25)
k10e <- kmeans(dfe, centers = 10, nstart = 25)

```

Plots to compare clusters:

```{r plot-k-means-env-select, fig.align='center', fig.width=12, fig.height=8}
p1 <- fviz_cluster(k2e, geom = "point", data = dfe) + ggtitle("k = 2")
p2 <- fviz_cluster(k3e, geom = "point",  data = dfe) + ggtitle("k = 3")
p3 <- fviz_cluster(k4e, geom = "point",  data = dfe) + ggtitle("k = 4")
p4 <- fviz_cluster(k5e, geom = "point",  data = dfe) + ggtitle("k = 5")
p7 <- fviz_cluster(k7e, geom = "point",  data = dfe) + ggtitle("k = 5")
p10 <- fviz_cluster(k10e, geom = "point",  data = dfe) + ggtitle("k = 5")

(p.all.spp <- (p1 + p2) / (p3 + p4) / (p7 + p10))

ggsave(here::here("plots", "explore", "kmeans_enviro_select.pdf"), 
       width = 12, height = 8, device = cairo_pdf)
```



## Next Steps

* run RF models to identify most important variables predicting spp. P/A in reaches
* run cluster analysis on stream reaches using important enviro variables
* run LDA to predict and check classification accuracy



*** 

## Convert PDF to PNG 
```{r convert-pdfs}
## convert PDF to PNG
path <- here::here("plots", "explore")
pdfs <- list.files(path, pattern = "*.pdf", recursive = TRUE)
for(pdf in pdfs) {
  pdf_convert(pdf = glue::glue("{path}/{pdf}"), 
              filenames = glue::glue("{path}/{str_remove(pdf, '.pdf')}.png"),
              format = "png", dpi = 500)
}
```

## Session Info

```{r session}
Sys.time()
# git2r::repository()
sessionInfo()
```