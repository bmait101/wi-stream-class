---
title: "WI Stream Classes: exploratory data analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

## Objectives / To Do

+ ~~classify/cluster streams by fish community & environmental data~~
* run LDA to predict and check classification accuracy
+ calculate fish metrics among classes = standards / opportunities


## Prep 

```{r setup, include=FALSE}
ragg_png = function(..., res = 150) {
  ragg::agg_png(..., res = res, units = "in")
}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      dev = "ragg_png", res = 500, retina = 1)
```

```{r prep, warning=FALSE, message=FALSE}
# packages
library(tidyverse)  # data manipulation
library(cluster)    # clustering algorithms
library(factoextra) # clustering algorithms & visualization
library(patchwork)  # panel plots
library(vegan)      # community analsyses
library(pdftools)   # covert pdfs to pngs


# function to do kmeans analysis on a data given a # of clusters
f_kmeans <- function(dat, clusters, ...){
  kmeans(x = dat, centers = clusters, nstart = 25)
}

# function to pull total within-cluster sum of square 
wss <- function(kmeans_ob) {
  kmeans_ob$tot.withinss
}

# function to plot kmeans cluster objects
f_fviz_cluster_plots <- function(dat, kmeans_ob, ...){
  fviz_cluster(
    object = kmeans_ob, 
    data = dat, 
    geom = "point", 
    main = paste("Clusters = ", length(kmeans_ob$size)),
    ggtheme = theme_minimal()
    )
}

```



## Data

```{r read-data, echo=FALSE}
source(here::here("R", "13_prep-data.R"))  # ~1-2 min load time
```

There are two primary datasets: 

* Fish community data: Catch and effort data for all electrofishing surveys (boom, backpack, barge) done on streams by the WDNR from 1994-2020. Excludes all lake and Mississippi River sites. Data was pulled from the WDNR FMIS on 18 April 2022. 
* 24k WI Hydrography attribute data: A geodatabase of channel, riparian, and watershed attributes for all stream and lake features in 1:24,000 WI Hydrography database. Available at for download [here](https://www.arcgis.com/home/item.html?id=c4bc634ba115498487174bda137f8de8).


## Fish Community

Goal: Partition streams into groups based on reach-level fish species presence-absence data. We do this for two objectives: 

* ecology (the whole fish community)
* fisheries (primary sportfish species)


### Prep data

We will analyze presence / absence matrices for the fish community. 

```{r compute-pa-matricies}

# All species ------
pa_all <- 
  df_fish %>% 
  group_by(species, reach_id) %>% 
  summarise(present = sum(fish.count), 
            .groups = 'drop') %>% 
  mutate(present = if_else(present >= 1, 1, 0)) %>% 
  pivot_wider(names_from = "species", values_from = "present", values_fill = 0) %>%
  column_to_rownames("reach_id")


# Sport fish ----

# list of sportfish species
sport.spp <- c(
  "muskellunge", "northern_pike", "walleye", "sauger",
    "largemouth_bass", "smallmouth_bass", 
    "channel_catfish", "flathead_catfish",
    "brook_trout", "brown_trout", "rainbow_trout",
    "lake_sturgeon", 
    "black_crappie", "bluegill", "green_sunfish", "pumpkinseed", 
    "rock_bass", "yellow_perch"
  )
# list of pan fish species (subset of above)
pan.spp <- c(
    "black_crappie", "bluegill", "green_sunfish", "pumpkinseed", 
    "rock_bass", "yellow_perch"
  )
# list of trout species  (subset of above)
trout.spp <- c("brook_trout", "brown_trout", "rainbow_trout")

# P/A for sportfish
pa_sport <- 
  df_fish %>% 
  filter(species %in% sport.spp) %>% 
  mutate(
    species = case_when(
      species %in% c("channel_catfish","flathead_catfish") ~ "catfish",
      species %in% pan.spp ~ "panfish",
      # species %in% trout.spp ~ "trout",
      TRUE ~ species
  )) %>%
  group_by(species, reach_id) %>% 
  summarise(present = sum(fish.count), 
            .groups = 'drop') %>% 
  mutate(present = if_else(present >= 1, 1, 0)) %>% 
  pivot_wider(names_from = "species", values_from = "present", values_fill = 0) %>%
  column_to_rownames("reach_id")

# pa_sport_reaches <- row.names(pa_sport)
```

### PCA

We do a PCA beacuse it can help us interpret the vizualizations from the kmeans analysis. 

```{r pca-fish-all}
# run analysis
pca_fish_all <- prcomp(pa_all, center = TRUE, scale. = TRUE)
```


```{r biplot-fish-all, fig.align='center', fig.width=12, fig.height=8}
# Full biplot
p.pca.fish.all <- 
  fviz_pca_biplot(
    pca_fish_all, 
    geom.ind = c("point"), 
    title = "PCA - Biplot: Fish P/A All Species"
    )
p.pca.fish.all
```


```{r pca-fish-sport}
# run analysis
pca_fish_sport <- prcomp(pa_sport, center = TRUE, scale. = TRUE)
```


```{r biplot-fish-sport, fig.align='center', fig.width=12, fig.height=8}
# Full biplot
p.pca.fish.sport <- 
  fviz_pca_biplot(
    pca_fish_sport, 
    geom.ind = c("point"), 
    title = "PCA - Biplot: Fish P/A Sportfish Species"
    )
p.pca.fish.sport
```


### Clustering: all species

Clustering and plots: 

```{r cluster-fish-all, fig.align='center', fig.width=12, fig.height=16}

# Clustering for 1 to 10
pa_all_clusters <- seq_along(1:10) %>% map(f_kmeans, dat = pa_all)

# PLots
pa_all_plots <- map(pa_all_clusters, f_fviz_cluster_plots, dat = pa_all)

# Print plot 2, 4, 6, 8
panel <- 
  (pa_all_plots[[2]] + pa_all_plots[[4]]) /
  (pa_all_plots[[6]] + pa_all_plots[[8]]) /
  p.pca.fish.all + 
  plot_layout(heights = c(.5,.5,1))

panel + 
  plot_annotation(
    title = "k-means clustering on stream community P/A data (all species)"
    )


# Save
ggsave(here::here("plots", "explore", "kmeans_fish.pdf"),
       width = 12, height = 16, device = cairo_pdf)
```


Elbow method for optimal clusters:

```{r elbow-fish-all, fig.align='center', fig.width=6, fig.height=4}
plot(1:10, map_dbl(pa_all_clusters, wss),
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
```

Inflection after 3 groups, then another kind at 8 clusters. 


### Clustering: sportfish

Clustering and plots: 

```{r cluster-fish-sport, fig.align='center', fig.width=12, fig.height=12}

# Clustering for 1 to 10
pa_sport_clusters <- seq_along(1:10) %>% map(f_kmeans, dat = pa_sport)

# PLots
pa_sport_plots <- map(pa_sport_clusters, f_fviz_cluster_plots, dat = pa_sport)

# Print plot 2, 4, 6, 8
panel <- 
  (pa_sport_plots[[2]] + pa_sport_plots[[4]]) /
  (pa_sport_plots[[6]] + pa_sport_plots[[8]]) /
  p.pca.fish.sport + 
  plot_layout(heights = c(.6,.6,1))

panel + 
  plot_annotation(
    title = "k-means clustering on stream community P/A data (sportfish species)"
    )

# Save plot
ggsave(here::here("plots", "explore", "kmeans_sportfish.pdf"),
       width = 12, height = 8, device = cairo_pdf)

```


Elbow method for optimal clusters:

```{r elbow-fish-sport, fig.align='center', fig.width=6, fig.height=4}
plot(1:10, map_dbl(pa_sport_clusters, wss),
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
```



## Environmental Data

### Prep data

Inspect / Check for missing data: 

```{r skim-env-data}
skimr::skim(whd_data)
```

Filter, remove NAs, and scale data: 

```{r prep-env-data}

# all data minus the distance measures that have too many NAs
whd_data_all <- whd_data %>% 
  select(!ends_with("dist")) %>%
  na.omit() %>% 
  mutate(across(-reach_id, scale)) %>% 
  column_to_rownames("reach_id") 


# stream with fish data
whd_data_fish <- whd_data_all %>% 
  rownames_to_column("reach_id") %>% 
  filter(reach_id %in% df_fish$reach_id)  %>% 
  column_to_rownames("reach_id") 

# stream with fish data and selected temp/flow metrics
whd_data_fish_slct <- whd_data_fish %>% 
  select(trw_area, gradient, sinuosity,
    w_prcp_ann, trw_prcp_ann,
    temp_max_cl_cc, temp_july_cl_cc, temp_summer_cl_cc,
    apr_e10_c, aug_e50_c, wy_e50_c, wy_e90_c | contains("temp")
    )

```


### PCA 

Compute PCs of environmental data and understand their role in variation. 

#### All streams

```{r pca-whd-all}
# run analysis
pca_whd_all <- prcomp(whd_data_all, center = TRUE, scale. = TRUE)
```


```{r biplot-env-all, fig.align='center', fig.width=12, fig.height=8}
# Full biplot
fviz_pca_biplot(
  pca_whd_all, 
  geom.ind = c("point"), 
  title = "PCA - Biplot: All streams"
  )
```


```{r varload-env-all, fig.align='center', fig.width=12, fig.height=8}
# Variable loadings only
fviz_pca_var(
  pca_whd_all, 
  col.var = "black", 
  title = "PCA Variable Loadings: All streams",
  repel = TRUE
  )
```


#### Streams with fish

```{r pca-whd-fish}
# run analysis
pca_whd_fish <- prcomp(whd_data_fish, center = TRUE, scale. = TRUE)
```


```{r biplot-env-fish, fig.align='center', fig.width=12, fig.height=8}
# Full biplot
fviz_pca_biplot(
  pca_whd_fish, 
  geom.ind = c("point"), 
  title = "PCA - Biplot: Streams with fish surveys"
  )

# Save plot
ggsave(here::here("plots", "explore", "pca_biplot_env_fish.pdf"),
       width = 12, height = 8, device = cairo_pdf)

```


```{r varload-env-fish, fig.align='center', fig.width=12, fig.height=8}
# Variable loadings only
fviz_pca_var(
  pca_whd_fish, 
  col.var = "black", 
  title = "PCA Variable Loadings: Streams with fish surveys",
  repel = TRUE
  )
```



### k-means cluster

#### Clustering: all streams **NOT RUN**

Clustering and plots: **NOT RUN**

```{r cluster-whd-all, fig.align='center', fig.width=12, fig.height=12, eval=FALSE}

# Clustering for 1 to 10
whd_data_all_clusters <- seq_along(1:10) %>% map(f_kmeans, dat = whd_data_all)

# PLots
whd_data_all_plots <- map(whd_data_all_clusters, f_fviz_cluster_plots, dat = whd_data_all)

# Print plot 2, 4, 6, 8
(whd_data_all_plots[[2]] + whd_data_all_plots[[4]]) /
  (whd_data_all_plots[[6]] + whd_data_all_plots[[8]]) + 
  plot_annotation(
    title = "k-means clustering on environmental data (all streams)"
    )

# Save plot
# ggsave(here::here("plots", "explore", "kmeans_sportfish.pdf"), 
#        width = 12, height = 8, device = cairo_pdf)

```


Elbow method for optimal clusters: **NOT RUN**

```{r elbow-whd-all, fig.align='center', fig.width=6, fig.height=4, eval=FALSE}
plot(1:10, map_dbl(whd_data_all_clusters, wss),
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
```


#### Clustering: streams with fish surveys

Clustering and plots:

```{r cluster-whd-fish, fig.align='center', fig.width=12, fig.height=12}

# Clustering for 1 to 10
whd_data_fish_clusters <- seq_along(1:10) %>% map(f_kmeans, dat = whd_data_fish)

# PLots
whd_data_fish_plots <- map(whd_data_fish_clusters, f_fviz_cluster_plots, dat = whd_data_fish)

# Print plot 2, 4, 6, 8
(whd_data_fish_plots[[2]] + whd_data_fish_plots[[4]]) /
  (whd_data_fish_plots[[6]] + whd_data_fish_plots[[8]]) + 
  plot_annotation(
    title = "k-means clustering on environmental data (streams with fish surveys)"
    )

# Save plot
# ggsave(here::here("plots", "explore", "kmeans_sportfish.pdf"), 
#        width = 12, height = 8, device = cairo_pdf)

```


Elbow method for optimal clusters:

```{r elbow-whd-fish, fig.align='center', fig.width=6, fig.height=4}
plot(1:10, map_dbl(whd_data_fish_clusters, wss),
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
```


Map the clusters (4 vs. 8):
```{r map-clusters, fig.align='center', fig.width=12, fig.height=10, echo=FALSE}

pdat <- whd_data_fish %>%
  as_tibble() %>%
  mutate(cluster = whd_data_fish_clusters[[4]]$cluster,
         reach_id = row.names(whd_data_fish)) %>% 
  relocate(reach_id, .before = trw_area)

p.map4 <- whd_lines %>% 
  left_join(pdat %>% select(reach_id, cluster), by="reach_id") %>% 
  filter(!is.na(cluster)) %>% 
  ggplot() +
  geom_sf(data=wdnr.gis::wi_poly, color = "black", fill="white") + 
  geom_sf(data=whd_lines %>% filter(wbic==1179900), color="black") +
  geom_sf(aes(color = as.factor(cluster)), size=1) +
  theme_void() + 
  theme(legend.position="none", 
        plot.margin = unit(c(0, 0, 0, 0), "null"))


pdat <- whd_data_fish %>%
  as_tibble() %>%
  mutate(cluster = whd_data_fish_clusters[[8]]$cluster,
         reach_id = row.names(whd_data_fish)) %>% 
  relocate(reach_id, .before = trw_area)

p.map9 <- whd_lines %>% 
  left_join(pdat %>% select(reach_id, cluster), by="reach_id") %>% 
  filter(!is.na(cluster)) %>% 
  ggplot() +
  geom_sf(data=wdnr.gis::wi_poly, color = "black", fill="white") + 
  geom_sf(data=whd_lines %>% filter(wbic==1179900), color="black") +
  geom_sf(aes(color = as.factor(cluster)), size=1) +
  theme_void() + 
  theme(legend.position="none", 
        plot.margin = unit(c(0, 0, 0, 0), "null"))

# Plot panel
panel <- 
  (whd_data_fish_plots[[4]] / whd_data_fish_plots[[8]]) |
  (p.map4 / p.map9) 

panel + 
  plot_layout(widths = c(.5, .5)) +
  plot_annotation(
    title = "k-means cluster analysis on climate/environemtnal data for WI streams",
    subtitle = "Clustering done on streams with fish surveys (n=9,526 steams)"
  )

ggsave(here::here("plots", "explore", "kmeans_env_fish_streams.pdf"),
       width = 12, height = 10, device = cairo_pdf)

```




*** 

## Convert PDF to PNG 
```{r convert-pdfs}
## convert PDF to PNG
path <- here::here("plots", "explore")
pdfs <- list.files(path, pattern = "*.pdf", recursive = TRUE)
for(pdf in pdfs) {
  pdf_convert(pdf = glue::glue("{path}/{pdf}"), 
              filenames = glue::glue("{path}/{str_remove(pdf, '.pdf')}.png"),
              format = "png", dpi = 500)
}
```

## Session Info

```{r session}
Sys.time()
# git2r::repository()
sessionInfo()
```